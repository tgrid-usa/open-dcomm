const e=window.location.host;console.log(e);const t=Gun([`https://${e}/gun`]),n="https://ipfs-backend.uat.trustgrid.com";let o,s,a,i,c,r=null,l=null,d=null,u=!1,m=[],g=null,p=!1;const y=2e3,f=document.getElementById("auth"),h=document.getElementById("chat"),w=document.getElementById("login"),E=document.getElementById("register"),C=document.getElementById("username"),v=document.getElementById("password"),I=document.getElementById("messages"),T=document.getElementById("messageInput"),L=document.getElementById("sendMessage"),b=document.getElementById("contactsList"),x=document.getElementById("groupsList"),A=document.getElementById("newContactInput"),B=document.getElementById("addContact"),S=document.getElementById("createGroup"),$=document.getElementById("newGroupName"),k=document.getElementById("currentChatHeader"),R=document.getElementById("messageControls"),D=document.getElementById("addToGroup"),N=document.getElementById("addToGroupInput"),M=document.getElementById("startVoiceCall"),O=document.getElementById("endVoiceCall"),H=document.getElementById("callControls"),q=document.getElementById("remoteAudio"),V=document.getElementById("startVideoCall"),j=document.getElementById("endCall");async function P(e,n,s){const a=n||C.value.trim(),i=s||v.value;if(a&&i)return o=t.user(),new Promise(((e,n)=>{o.create(a,i,(o=>{o.err?(console.log(o.err),n(new Error("registration Failed"))):(t.get("users").get(a).put({username:a}),console.log("Registration successful. You can now log in."),e(!0))}))}));await showCustomAlert("Please enter both username and password")}function F(e,n,s){const a=n||C.value.trim(),i=s||v.value;return console.log(a,i),o=t.user(),new Promise(((e,n)=>{o.auth(a,i,(s=>{s.err?(console.log(s.err),n(new Error("Login Failed"))):(console.log("User authenticated:",o.is.alias),t.get("users").get(a).put({username:a}),z(),e(!0))}))}))}function U(){console.log("Loading contacts for",o.is.alias),b.innerHTML="",o.get("contacts").map().on(((e,t)=>{if(console.log("Contact data:",t,e),e&&e.alias&&!b.querySelector(`[data-id="${t}"]`)){const n=document.createElement("div");n.textContent=e.alias,n.dataset.id=t,n.classList.add("contact"),n.addEventListener("click",(()=>J(e.alias))),b.appendChild(n)}}))}function J(e){Ne(),r=e,l="direct",k.textContent=`${e}`,I.innerHTML="",R.classList.remove("hidden"),H.classList.remove("hidden"),D.classList.add("hidden"),N.classList.add("hidden"),ve(e)}function G(){const e=T.value.trim();if(e&&r){if(c&&clearTimeout(c),ke(!1),"direct"===l){const n=_(o.is.alias,r);t.get("chats").get(n).set({sender:o.is.alias,content:e,timestamp:Date.now(),notified:!1})}else"group"===l&&t.get("groupChats").get(r).set({sender:o.is.alias,content:e,timestamp:Date.now(),notified:!1});T.value=""}}function W(){const e=A.value.trim();e&&e!==o.is.alias&&t.get("users").get(e).once((async n=>{console.log("Looking up user:",e,"Result:",n),n&&n.username?(t.get("users").get(e).get("contactRequests").set({from:o.is.alias,timestamp:Date.now()},(e=>{console.log("Contact request sent:",e)})),A.value="",await showCustomAlert(`Contact request sent to ${e}`)):await showCustomAlert(`User ${e} does not exist.`)}))}function K(){console.log("I am running"),o.get("contactRequests").map().on((async(e,n)=>{if(console.log(e),e&&e.from&&!e.handled){await showCustomConfirm(`${e.from} wants to add you as a contact. Accept?`)?(o.get("contacts").get(e.from).put({alias:e.from}),t.get("users").get(e.from).get("contacts").get(o.is.alias).put({alias:o.is.alias}),o.get("contactRequests").get(n).put(null),U()):o.get("contactRequests").get(n).put({...e,handled:!0})}}))}function _(e,t){return[e,t].sort().join("_")}function z(){console.log("Initializing app"),o&&o.is&&(f.classList.add("hidden"),h.classList.remove("hidden"),h.style.display="flex",U(),ee(),Y(),Q(),oe(),Se())}function Y(){console.log("Setting up contact request listener for",o.is.alias),t.get("users").get(o.is.alias).get("contactRequests").map().on(((e,t)=>{console.log("Received contact request:",e,t),e&&e.from&&!e.handled&&X(e,t)}))}async function X(e,n){console.log("Handling contact request:",e,n);await showCustomConfirm(`${e.from} wants to add you as a contact. Accept?`)?(o.get("contacts").get(e.from).put({alias:e.from},(e=>{console.log("Added contact for current user:",e)})),t.get("users").get(e.from).get("contacts").get(o.is.alias).put({alias:o.is.alias},(e=>{console.log("Added current user as contact for requester:",e)})),t.get("users").get(o.is.alias).get("contactRequests").get(n).put(null,(e=>{console.log("Removed contact request:",e)})),U(),t.get("users").get(e.from).get("contactAcceptances").set({from:o.is.alias,timestamp:Date.now()}),await showCustomAlert(`You are now connected with ${e.from}`)):t.get("users").get(o.is.alias).get("contactRequests").get(n).put(null,(e=>{console.log("Removed rejected contact request:",e)}))}function Q(){console.log("Setting up contact acceptance listener for",o.is.alias),t.get("users").get(o.is.alias).get("contactAcceptances").map().on((async(e,n)=>{console.log("Received contact acceptance:",e,n),e&&e.from&&(o.get("contacts").get(e.from).put({alias:e.from},(e=>{console.log("Added accepted contact for sender:",e)})),t.get("users").get(o.is.alias).get("contactAcceptances").get(n).put(null),U(),await showCustomAlert(`${e.from} has accepted your contact request!`))}))}function Z(){const e=$.value.trim();if(e){const n=`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={name:e,creator:o.is.alias,members:{[o.is.alias]:!0},createdAt:Date.now()};t.get("groups").get(n).put(s,(async e=>{e.err?await showCustomAlert("Error creating stream: "+e.err):(o.get("groups").set(n),$.value="",ee(),await showCustomAlert("Stream created successfully!"))}))}}function ee(){x.innerHTML="",o.get("groups").map().on((e=>{e&&t.get("groups").get(e).once((t=>{if(t&&t.name&&!x.querySelector(`[data-id="${e}"]`)){const n=document.createElement("div");n.textContent=t.name,n.dataset.id=e,n.classList.add("group"),n.addEventListener("click",(()=>te(e,t.name))),x.appendChild(n)}}))}))}function te(e,t){Ne(),r=e,l="group",k.textContent=`Stream: ${t}`,I.innerHTML="",R.classList.remove("hidden"),H.classList.add("hidden"),D.classList.remove("hidden"),N.classList.remove("hidden"),Ie(e)}async function ne(){const e=N.value.trim();e&&r&&"group"===l&&t.get("groups").get(r).once((async n=>{n.creator===o.is.alias?n.members[e]?await showCustomAlert(`${e} is already a member of this stream`):t.get("groups").get(r).get("members").get(e).put(!0,(async s=>{s.err?await showCustomAlert("Error adding user to stream: "+s.err):(t.get("users").get(e).get("groupInvitations").set({groupId:r,from:o.is.alias,groupName:n.name,timestamp:Date.now()}),N.value="",await showCustomAlert(`Invitation sent to ${e}`))})):await showCustomAlert("Only the stream creator can add new members")}))}function oe(){t.get("users").get(o.is.alias).get("groupInvitations").map().on((async(e,n)=>{if(e&&!e.handled){await showCustomConfirm(`${e.from} invited you to join the stream "${e.groupName}". Accept?`)?(o.get("groups").set(e.groupId),t.get("groups").get(e.groupId).get("members").get(o.is.alias).put(!0),ee(),t.get("users").get(o.is.alias).get("groupInvitations").get(n).put(null,(e=>{console.log("Removed accepted stream invitation:",e)}))):t.get("users").get(o.is.alias).get("groupInvitations").get(n).put(null,(e=>{console.log("Removed rejected stream invitation:",e)}))}}))}async function se(e=!1){if(u||"direct"!==l)await showCustomAlert("A call is already in progress or you're not in a direct chat.");else try{u=!0,p=e;const n={audio:!0,video:e};a=await navigator.mediaDevices.getUserMedia(n),console.log("Local stream obtained:",a.getTracks()),e&&(document.getElementById("localVideo").srcObject=a,document.getElementById("videoContainer").classList.remove("hidden")),d=await s.createPeerConnection();const i=await s.startCall(a),c=Date.now().toString();g={id:c,to:r,from:o.is.alias,startTime:Date.now(),isVideo:e};const l={type:"offer",callId:c,from:o.is.alias,to:r,offerType:i.type,offerSdp:i.sdp,startTime:g.startTime,isVideo:e};t.get("calls").get(c).put(l),console.log("Offer sent:",l),pe(c),M.classList.add("hidden"),V.classList.add("hidden"),j.classList.remove("hidden"),setTimeout((async()=>{d&&"connected"!==d.iceConnectionState&&"completed"!==d.iceConnectionState&&(console.log("Call setup timeout. Current ICE state:",d.iceConnectionState),await showCustomAlert("Call setup timed out. Please try again."),ae())}),3e4)}catch(e){console.error("Error starting call:",e),await showCustomAlert("Error starting call: "+e.message),u=!1,a&&a.getTracks().forEach((e=>e.stop())),g=null}}function ae(){d&&(d.close(),d=null),a&&(a.getTracks().forEach((e=>e.stop())),a=null),q.srcObject=null,document.getElementById("remoteVideo").srcObject=null,document.getElementById("localVideo").srcObject=null,document.getElementById("videoContainer").classList.add("hidden"),g&&(t.get("calls").get(g.id).put({type:"end",from:o.is.alias,to:g.to,endTime:Date.now()}),g=null),u=!1,p=!1,M.classList.remove("hidden"),document.getElementById("startVideoCall").classList.remove("hidden"),document.getElementById("endCall").classList.add("hidden")}function ie(){s=new WebRTCHandler(ue,Ae)}function ce(e,n){const s={candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex};t.get("calls").get(e).put({type:"ice",from:o.is.alias,ice:JSON.stringify(s),time:Date.now()})}function re(e,t){if(t&&t.ice)try{const e=JSON.parse(t.ice);d&&s.addIceCandidate(new RTCIceCandidate(e)).catch((e=>console.error("Error adding ICE candidate:",e)))}catch(e){console.error("Error parsing ICE candidate:",e)}}function le(e,t){const n=new(window.AudioContext||window.webkitAudioContext),o=n.createMediaStreamSource(e),s=n.createAnalyser();s.fftSize=256,o.connect(s);const a=new Uint8Array(s.frequencyBinCount);!function e(){s.getByteFrequencyData(a);const n=a.reduce(((e,t)=>e+t))/a.length;console.log(`${t} audio level:`,n),requestAnimationFrame(e)}()}async function de(e){if(u)return void console.log("Already in a call, ignoring incoming call");const n=e.isVideo?"video":"voice";if(confirm(`Incoming ${n} call from ${e.from}. Accept?`))try{u=!0,p=e.isVideo;const n={audio:!0,video:e.isVideo};a=await navigator.mediaDevices.getUserMedia(n),console.log("Local stream obtained:",a.getTracks()),e.isVideo&&(document.getElementById("localVideo").srcObject=a,document.getElementById("videoContainer").classList.remove("hidden")),d=await s.createPeerConnection();const i={type:e.offerType,sdp:e.offerSdp},c=await s.handleIncomingCall(i,a);g={id:e.callId,to:e.from,from:o.is.alias,startTime:Date.now(),isVideo:e.isVideo};const r={type:"answer",callId:e.callId,from:o.is.alias,to:e.from,answerType:c.type,answerSdp:c.sdp,time:g.startTime,isVideo:e.isVideo};t.get("calls").get(e.callId).put(r),console.log("Answer sent:",r),pe(e.callId),M.classList.add("hidden"),V.classList.add("hidden"),j.classList.remove("hidden"),ge(e.callId),setTimeout((async()=>{d&&"connected"!==d.iceConnectionState&&"completed"!==d.iceConnectionState&&(console.log("Call setup timeout. Current ICE state:",d.iceConnectionState),await showCustomAlert("Call setup timed out. Please try again."),ae())}),3e4)}catch(e){console.error("Error accepting call:",e),await showCustomAlert(`Error accepting call: ${e.message}`),ae()}else t.get("calls").get(e.callId).put({type:"reject",from:o.is.alias,to:e.from,time:Date.now()})}function ue(e){if(e.candidate){const t={from:o.is.alias,candidate:{candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex},timestamp:Date.now()};m.push(t),g?me(g.id,t):console.log("ICE candidate generated before call is established. Buffering...")}}function me(e,n){t.get("calls").get(e).get("iceCandidates").set(JSON.stringify(n))}function ge(e){m.forEach((t=>{me(e,t)})),m=[]}function pe(e){t.get("calls").get(e).get("iceCandidates").map().on((e=>{if(e)try{const t=JSON.parse(e);t&&t.from!==o.is.alias&&(console.log("Received ICE candidate:",t),s.addIceCandidate(t.candidate))}catch(e){console.error("Error parsing ICE candidate:",e)}}))}async function ye(e){const t=await e.arrayBuffer(),o=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),s=crypto.getRandomValues(new Uint8Array(12)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,t),i=new Blob([a],{type:e.type}),c=new FormData;c.append("file",i,e.name);const r=await fetch(`${n}/upload`,{method:"POST",body:c});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const l=(await r.json()).ipfs.IpfsHash,d=await crypto.subtle.exportKey("raw",o);console.log({cid:l,encryptedSymKey:Le(d),iv:Le(s),fileName:e.name,fileType:e.type});const u={cid:l,encryptedSymKey:Le(d),iv:Le(s),fileName:e.name,fileType:e.type};return JSON.stringify(u)}async function fe(){const e=document.createElement("div");return e.className="custom-dialog",e.innerHTML='\n    <div class="dialog-content">\n      <p>Set file expiration time (in minutes)</p>\n      <p>Enter 0 for no expiration</p>\n      <input type="number" min="0" id="expiryInput" class="input-box-style" value="0">\n      <div class="dialog-buttons">\n        <button class="primary-button-style" id="confirmExpiry">Confirm</button>\n        <button class="primary-button-style" id="cancelExpiry">Cancel</button>\n      </div>\n    </div>\n  ',document.body.appendChild(e),new Promise((t=>{document.getElementById("confirmExpiry").onclick=()=>{const n=parseInt(document.getElementById("expiryInput").value)||0;document.body.removeChild(e),t(n)},document.getElementById("cancelExpiry").onclick=()=>{document.body.removeChild(e),t(null)}}))}function he(e){return e.type.startsWith("image/")?"image":e.type.startsWith("video/")?"video":e.type.startsWith("application/")||e.type.startsWith("text/")?"document":"other"}async function we(){const e=document.getElementById("fileInput");e.files[0]||(e.click(),await new Promise((t=>{e.onchange=()=>t()})));const n=e.files[0];if(!n)return void await showCustomAlert("No file selected.");const s=he(n);if("other"===s)return await showCustomAlert("Unsupported file type. Please select an image, video, or document."),void(e.value="");try{const a=0;if(null===a)return void(e.value="");const i=0===a?Number.MAX_SAFE_INTEGER:Date.now()+60*a*1e3;Be(n,s);const c=await ye(n),d=JSON.parse(c);d.expiryTime=i,d.fileType=s;const u={sender:o.is.alias,type:"file",content:JSON.stringify(d),timestamp:Date.now()};"direct"===l?t.get("chats").get(_(o.is.alias,r)).set(u):"group"===l&&t.get("groupChats").get(r).set(u),console.log("File sent successfully!"),e.value=""}catch(t){console.error("Error sending file:",t),e.value="",await showCustomAlert("Error sending file. Please try again.")}}async function Ee(e){try{const t=JSON.parse(e);if(t.expiryTime&&t.expiryTime<Date.now())throw new Error("File has expired");const o=await fetch(`${n}/getFile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cid:t.cid})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const s=(await o.json()).result,a=await fetch(s);if(!a.ok)throw new Error(`File download failed: ${a.statusText}`);const i=parseInt(a.headers.get("Content-Length")||"0");let c=0;const r=[],l=a.body.getReader();for(;;){const{done:e,value:t}=await l.read();if(e)break;if(r.push(t),c+=t.length,i>0){const e=c/i*100;console.log(`Download progress: ${e.toFixed(2)}%`)}}const d=new Uint8Array(c);let u=0;for(const e of r)d.set(e,u),u+=e.length;const m=await crypto.subtle.importKey("raw",be(t.encryptedSymKey),{name:"AES-GCM",length:256},!1,["decrypt"]),g=await crypto.subtle.decrypt({name:"AES-GCM",iv:be(t.iv)},m,d);Be(new Blob([g],{type:t.fileType}),t.fileType,!0)}catch(e){console.error("Error receiving file:",e),"File has expired"===e.message?await showCustomAlert("This file has expired and is no longer available."):await showCustomAlert("Error receiving file. Please try again.")}}async function Ce(e){try{const t=await fetch(`${n}/deleteFile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cid:e})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.json();console.log("File deleted:",o)}catch(e){console.error("Error deleting file:",e)}}function ve(e){const n=_(o.is.alias,e);t.get("chats").get(n).map().on(((e,t)=>{Te(e,t)}))}function Ie(e){t.get("groupChats").get(e).map().on(((e,t)=>{Te(e,t)}))}function Te(e,t){if(e&&!I.querySelector(`[data-id="${t}"]`)){const n=document.createElement("div");if("file"===e.type&&e.content)try{const t=JSON.parse(e.content),o=t.expiryTime&&t.expiryTime<Date.now();if(n.textContent=`${e.sender} sent a ${t.fileType}: ${t.fileName}`,o){const e=document.createElement("span");e.textContent=" (Expired)",e.style.color="#ff4444",n.appendChild(e)}else{const t=document.createElement("button");t.textContent="Download",t.className="primary-button-style",t.addEventListener("click",(()=>Ee(e.content))),n.appendChild(t)}}catch(t){console.error("Error parsing file content:",t),n.textContent=`${e.sender}: Error displaying file`}else n.textContent=`${e.sender}: ${e.content}`;n.dataset.id=t,n.classList.add("message",e.sender===o.is.alias?"sent":"received"),I.appendChild(n),I.scrollTop=I.scrollHeight}}function Le(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return btoa(t)}function be(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}function xe(e){const t=URL.createObjectURL(e),n=document.createElement("img");n.src=t,n.style.maxWidth="200px",n.style.maxHeight="200px";const o=document.getElementById("messages");o.appendChild(n),o.scrollTop=o.scrollHeight}function Ae(e){if(console.log("Received remote track:",e.track.kind),"audio"===e.track.kind)q.srcObject=e.streams[0];else if("video"===e.track.kind){document.getElementById("remoteVideo").srcObject=e.streams[0]}}function Be(e,t,n=!1){const o=URL.createObjectURL(e),s=document.createElement("div");let a;switch(s.className="file-preview",t){case"image":a=document.createElement("img"),a.src=o,a.style.maxWidth="200px",a.style.maxHeight="200px";break;case"video":a=document.createElement("video"),a.src=o,a.controls=!0,a.style.maxWidth="200px",a.style.maxHeight="200px";break;case"document":a=document.createElement("div"),a.className="document-preview",a.innerHTML=`\n        <i class="document-icon">ðŸ“„</i>\n        <span>${e.name}</span>\n      `}s.appendChild(a),I.appendChild(s),n||s.classList.add("sent"),I.scrollTop=I.scrollHeight}function Se(){T.addEventListener("input",$e),T.addEventListener("blur",(()=>{c&&clearTimeout(c),ke(!1)})),Re()}function $e(){r&&T.value.trim()?(c&&clearTimeout(c),c=setTimeout((()=>{ke(!1)}),y),ke(!0)):ke(!1)}function ke(e){if(!r||!o)return;const n={user:o.is.alias,isTyping:e,timestamp:Date.now()};"direct"===l?t.get("typing").get(_(o.is.alias,r)).put(n):"group"===l&&t.get("groupTyping").get(r).get(o.is.alias).put(n)}function Re(){t.get("typing").map().on(((e,t)=>{e&&e.user&&e.user!==o.is.alias&&"direct"===l&&t===_(o.is.alias,r)&&De(e.user,e.isTyping)})),t.get("groupTyping").map().on(((e,n)=>{"group"===l&&n===r&&t.get("groupTyping").get(n).map().on((e=>{e&&e.user&&e.user!==o.is.alias&&De(e.user,e.isTyping)}))}))}function De(e,t){const n=`typing-${e}`;let o=document.getElementById(n);if(t){if(!o){o=document.createElement("div"),o.id=n,o.className="typing-indicator";const t=document.createElement("div");t.className="typing-dots";for(let e=0;e<3;e++){const e=document.createElement("span");e.className="dot",t.appendChild(e)}o.innerHTML=`\n        <span class="typing-text">${e} is typing</span>\n      `,o.appendChild(t);const s=document.getElementById("typingContainer");if(!s.contains(o)){s.appendChild(o);const e=document.getElementById("messages");e.scrollHeight-e.scrollTop-e.clientHeight<100&&(e.scrollTop=e.scrollHeight)}}}else o&&o.remove()}function Ne(){c&&clearTimeout(c),ke(!1),T.value="",I.innerHTML="",r=null,l=null}E.addEventListener("click",P),w.addEventListener("click",F),L.addEventListener("click",G),B.addEventListener("click",W),S.addEventListener("click",Z),D.addEventListener("click",ne),window.addEventListener("load",(()=>{ie(),o&&o.is&&z()})),t.on("auth",(()=>{console.log("User authenticated:",o.is.alias),t.get("calls").map().on((async(e,t)=>{if(e&&e.to&&e.to===o.is.alias)if("ice"===e.type)re(t,e);else if("offer"===e.type)de(e);else if("answer"===e.type&&d)try{await d.setRemoteDescription(new RTCSessionDescription({type:e.answerType,sdp:e.answerSdp}))}catch(e){console.error("Error setting remote description:",e)}else"end"===e.type&&ae()}))})),document.getElementById("sendFile").addEventListener("click",we),M.addEventListener("click",(()=>se(!1))),document.getElementById("startVideoCall").addEventListener("click",(()=>se(!0))),document.getElementById("endCall").addEventListener("click",ae);